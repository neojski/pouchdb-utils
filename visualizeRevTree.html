<!doctype html>
<html>
  <head>
    <style type="text/css">
      body{background: #F2F2F2; color: #333; font-family: "Helvetica", Arial,sans-serif;}
      label, input {font-size: 1.5em;}
    </style>
    <script src="http://download.pouchdb.com/pouchdb-nightly.min.js"></script>
    <script src="https://raw.github.com/daleharvey/pouchdb/master/src/plugins/pouchdb.visualizeRevTree.js"></script>
    <link href="https://raw.github.com/daleharvey/trakkr/gh-pages/style/trakkr.css" rel="stylesheet" type="text/css" />
    <script>
      onload = function(){
        var $ = function(id){return document.getElementById(id);};
        var urlInput = $('url');
        var docIdInput = $('docId');
        var submitButton = $('submit');
        var origVal = submitButton.value;
        var status = $('status');

        var done = function(){
          status.innerHTML = "OK";
        };

        var error = function(err){
          status.innerHTML = "Can't visualize document due to error (error: " + err.error + "; reason: " + err.reason + ")";
          done();
          return;
        };

        var initDB = function(callback){
          if (!urlInput.value || !docIdInput.value) return alert('Fill in the forms, please!');
          status.innerHTML = "working";
          var url = urlInput.value.replace(/^\s+|\s+$/g, '')
          var docId = docIdInput.value;
          var corsProxy = 'http://cors.io/';
          if($('cors').checked){
            name = corsProxy + url.replace(/^https?:\/\//, '');
          }else{
            name = url;
          }
          console.log(name, docId);
          Pouch(name, function(err, db){
            callback(err, db, docId);
          });
        };

        $('form').onsubmit = function(){
          initDB(function(err, db, docId){
            if(err){
              return error(err);
            }
            db.visualizeRevTree(docId, function(err, box){
              if(err){
                return error(err);
              }
              status.innerHTML = "OK";
              var svg = box.getElementsByTagName('svg')[0];
              svg.style.width = svg.getAttribute('viewBox').split(' ')[2] * 7 + 'px';
              svg.style.height = svg.getAttribute('viewBox').split(' ')[3] * 7 + 'px';
              svg.style.border = '2px solid';
              document.body.appendChild(box);
              done();
            });
          });
          return false;
        };

        $('export').onclick = function(){
          initDB(function(err, db, docId){
            db.get(docId, {revs: true, open_revs: "all"}, function(err, results){
              var docs = [];
              results.forEach(function(row){
                docs.push(row.ok);
              });
              console.log("Exported docs: ", JSON.stringify(docs));
              console.log("Pouchdb format: ", "db.bulkDocs({docs:"+JSON.stringify(docs)+"}, {new_edits:false}, function(err, res){})");
              done();
            });
          });
        };
      }
    </script>
  </head>
  <body>
    <section>
    <h1>Revision tree visualizer</h1>
    <p>You can you this small tool to create any tree you want and then export it to JSON. With that you can easily create Pouchdb tests as the returned format is compatible with couchdb (pouchdb) bulkDocs. Don't forget new_edits=false!</p>
    <p><form id="form">
      <ul>
        <li><label for="url">Database URL:</label><input type="text" id="url" name="url" placeholder="http://me.iriscouch/db/foo"/></li>
        <li><label for="docId">Document id:</label><input type="text" id="docId" name="docId" placeholder="foo" /></li>
        <li><label for="cors">Use CORS proxy:</label><input type="checkbox" id="cors" name="cors" checked /></li>
        <li><input type="submit" id="submit" value="visualize" /></li>
        <li><input type="button" id="export" value="export" /> (see console for output!)</li>
        <li><p id="status">status</p></li>
      </ul>
    </form></p>
    </section>
  </body>
</html>
